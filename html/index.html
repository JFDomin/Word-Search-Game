<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Search Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<label id="topMessage"></label>
<body>
<div id = "page1">
    <h1 style="text-align: center">Word Search Game</h1>
    <div id="table-container"style="display: flex;width: 100%";> </div>
    <div style="display: flex;width: 100%;"id="table-container"></div>

<div style="display:flex;">
    <div style="display:flex;flex-direction:column;width:20%"id = "Lobby">
        <div>Lobby</div>
        <label for="input-data">Enter nickname:</label>
        <input type="text" id="input-data" placeholder="Enter nickname" onchange="handleChange(event)">
        <button id = "join-button" onclick="handleNickEnter()">Join</button>
        <span id="error"></span>
    </div>


    <div style="display:flex;flex-direction:column;width:80%;border: 1px solid black;padding: 20px;margin-left: 5px;justify-content: center;"id = "WaitingPlayers">
        <div id="waiting-text">Waiting for Players...</div>
        <div style="display:flex;width: 80%;justify-content: space-around;" id="playerContainer">
        </div>
        <div style="display: flex;width: 30%;justify-content: space-between;padding: 0 5px;margin: 0 auto;">
            <button id="ready-btn" style="width: auto;"onclick="readyPlayer()" disabled>Ready Up</button>
            <button id="start-btn" style="width: auto;"onclick="startGame()" disabled>Start Game</button>
            
        </div>
    </div>
 </div>
</div>

<div id="page2" style="display: none;"></div>

<div id= "chat" style = "display: block;">
        <h2>Chat</h2>
        <div id="message-container"></div>
        <input type="text" id="chat-input" placeholder="Type your message..">
        <button id="send-button" onclick="sendMessage()">Send</button>
 </div>
 <script src="uidisplay.js"></script>

<script>
    var gameid;
     class UserEvent {
     GameId; // the game ID on the server
     PlayerIdx; // either PLAYER1 PLAYER2 PLYAER 3 or PLAYER4
     button; //what button they pressed 
     nickname; //the nickname entered if it is join button
     ready;
}
    let nickname = "";
    let error = document.getElementById("error");

    function handleMissingNickname(){
        console.log("player missing nickname")
        error.textContent = "Please enter a nickname."
        error.style.color = "red"
        return
    }
    function handleChange(event) {
    }
    function handleNickEnter(){
        const nickname = document.getElementById("input-data").value
        const joinButton = document.getElementById("join-button");
        // const readyButton = document.getElementById("ready-btn");
        // const startButton = document.getElementById("start-btn");
        console.log('nickname', nickname);
        console.log(gameid);
        if (!nickname) {
            handleMissingNickname();
        }
        else {
            U = new UserEvent;
            buttonType = "join";
            U.nickname = nickname;
            U.button = buttonType;
            U.GameId = gameid;
            connection.send(JSON.stringify(U));
            console.log(JSON.stringify(U));

            error.textContent = "";
            console.log("player joined: ", nickname);
            joinButton.disabled = true;
            // const playerContainer = document.getElementById("playerContainer");
            // const playerDiv = document.createElement("div");
            // playerDiv.className = "player";
            // playerDiv.textContent = nickname;
            // playerContainer.appendChild(playerDiv);


            // const playerIndex = players.length + 1;
            // const playerColor = playerColors["PLAYER" + playerIndex];
            // playerDiv.style.backgroundColor = playerColor;

            // Update the text if there are multiple players
            // if (playerContainer.children.length === 1) {
            //     const waitingText = document.getElementById("waiting-text");
            //     waitingText.textContent = "Waiting for another player...";
            // }
            // if (playerContainer.children.length > 1) {
            //     const waitingText = document.getElementById("waiting-text");
            //     waitingText.textContent = "Waiting for Players to ready up";
            // }
        }

    }
    function readyPlayer(){
        const nickname = document.getElementById("input-data").value
        // logic is not complete yet
        if (!nickname) {
            handleMissingNickname();
        }
        else {
            buttonType = "readyUp";
            U.button = buttonType;
            U.GameId = gameid;
            U.nickname = nickname;
            connection.send(JSON.stringify(U));
            console.log(JSON.stringify(U));
            error.textContent = ""
            console.log("player ready: ", nickname);
        }

    }
    function startGame(){
        const nickname = document.getElementById("input-data").value;
        if (!nickname) {
            handleMissingNickname();
        }
        else {
            console.log("game started by: ", nickname);
            buttonType = "startGame";
            U.button = buttonType;
            U.GameId = gameid;
            connection.send(JSON.stringify(U));
            console.log(JSON.stringify(U));
            // implement logic for number of players somewhere in java
        }
    }
</script>
</body>
<div id = "WaitingPlayers"></div>
<script src="uidisplay.js"></script>

<script>
    var connection = null;
    var serverUrl = "ws://" + window.location.hostname +":"+ (parseInt(location.port) + 100);
    document.getElementById("topMessage").innerHTML = "?";
    // Create the connection with the server
    connection = new WebSocket(serverUrl);

    connection.onopen = function (evt) {
        console.log("open - Connection established");
        document.getElementById("topMessage").innerHTML = " "

    }
    connection.onclose = function (evt) {
        console.log("close");
        document.getElementById("topMessage").innerHTML = "Server Offline"
    }
    connection.onmessage = function (evt) {
        const joinButton = document.getElementById("join-button");
        var msg;
        msg = evt.data;
        console.log("Message received: " + msg);
        const obj = JSON.parse(msg);
        
        if(obj.type === "chat") {
            displayChatMessage(data.sender,data.message);
            return;
        } else {
             console.log("recieved message: ", data);
        }
        
        if('NotUnique' === obj ){
            joinButton.disabled = false;
            error.textContent = "Name not Unique";
            error.style.color = "red";
            return;
        }
        else if('CantStart' === obj){
            error.textContent = "Not Enough Players Ready";
            error.style.color = "red";
            return;
        }
        if (obj.type == "wordGrid"){
            console.log(obj.data);
            //displayGrid(obj.data);
            const tableContainer = document.getElementById('table-container');
            tableContainer.innerHTML = displayGrid(obj.data);
            document.getElementById('table-container').style.display = 'none';
        }
        if('YouAre' in obj){
            if(obj.YouAre == "PLAYER1"){
                idx = 1;
                //setPlayerColor(playerColor);
            }
            else if (obj.YouAre == "PLAYER2"){
                idx = 2;
            }
            else if(obj.YouAre == "PLAYER3"){
                idx = 3;
            }
            else{
                idx = 4;
            }
            gameid = obj.GameId;
            console.log(msg);
        }
                //pay attention to only this game 
                if(gameid === obj.GameId){
            if ('playerList' in obj && Array.isArray(obj.playerList)) {
            console.log("got player list");
            //get the gameid out of the message specifically to update if gameid == to the msg gameid
            //this seperates the display of each game
            updatePlayerList(obj.playerList);
            }
            else if ('ActualGameStart' in obj){
                document.getElementById('Lobby').style.display = 'none';
                document.getElementById('table-container').style.display = 'block';
                document.getElementById('WaitingPlayers').style.display = 'none';
            }
        }
    }
    
    function updatePlayerList(playerList){
        const playerContainer = document.getElementById("playerContainer");
        const waitingText = document.getElementById("waiting-text");
        const readyButton = document.getElementById("ready-btn");
        const startButton = document.getElementById("start-btn");
        
        playerContainer.innerHTML = ""; // Clear existing player list
        
        playerList.forEach(function(player) {
            const playerDiv = document.createElement("div");
            playerDiv.className = "player";
            playerDiv.textContent = player.nickname;
            if (player.isReady) {
            playerDiv.style.color = 'green';
            }
            playerContainer.appendChild(playerDiv);
        });
        
        if (playerList.length === 1) {
            waitingText.textContent = "Waiting for another player...";
            readyButton.disabled = false; // Disable ready button when there's only one player
            startButton.disabled = true; // Disable start button when there's only one player
        } else {
            waitingText.textContent = "Waiting for Players to ready up";
            readyButton.disabled = false;
            startButton.disabled = false;
        }
        
    };
  

    </script>
    <link rel="stylesheet" href="style.css">
    </body>
    </html>